<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IGTechTeam - Comments</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 700px;
    }
    form {
      margin-bottom: 30px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      font-size: 14px;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }
    #comments .border {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<h2>Leave a Comment</h2>

<form method="POST" class="p-3 bg-light rounded shadow">
  <input type="hidden" name="parent_id" value="" />

  <div class="form-group">
    <label>Your Name</label>
    <input type="text" name="name" class="form-control" required />
  </div>

  <div class="form-group">
    <label>Your Comment</label>
    <textarea name="content" class="form-control" rows="3" required></textarea>
  </div>

  <button type="submit" class="btn btn-primary">Post Comment</button>
</form>

<hr />

<h3>Comments</h3>
<div id="comments">
  <p>Loading comments...</p>
</div>

<script>
(function () {
  const form = document.querySelector("form");
  const commentsContainer = document.getElementById("comments");
  if (!form || !commentsContainer) return;

  // Change slug to your post slug or dynamic value if needed
  const slug = "java-for-absolute-beginners-simplified-learning-with-notes-and-code-examples";
  const submitBtn = form.querySelector("button[type='submit']");

  form.addEventListener("submit", function (e) {
    e.preventDefault();
    submitBtn.disabled = true;
    const originalText = submitBtn.textContent;
    submitBtn.textContent = "Posting...";

    const data = {
      slug,
      name: form.name.value.trim(),
      content: form.content.value.trim(),
      parent_id: form.parent_id.value || null,
    };

    // Validate inputs lightly
    if (!data.name || !data.content) {
      alert("Please fill in your name and comment.");
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
      return;
    }

    fetch("/.netlify/functions/submit_comment", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    })
      .then(res => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        if (res.ok) {
          alert("Comment submitted!");
          form.reset();
          loadComments();
        } else {
          return res.text().then(text => alert("Failed: " + text));
        }
      })
      .catch(err => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        alert("Error: " + err.message);
      });
  });

  function loadComments() {
    fetch(`/.netlify/functions/get_comments?slug=${encodeURIComponent(slug)}`)
      .then(res => {
        if (!res.ok) throw new Error("Failed to load comments");
        return res.json();
      })
      .then(comments => {
        commentsContainer.innerHTML = "";
        const map = {};
        comments.forEach(c => {
          c.children = [];
          map[c.id] = c;
        });
        comments.forEach(c => {
          if (c.parent_id && map[c.parent_id]) {
            map[c.parent_id].children.push(c);
          }
        });

        const render = (comment) => {
          const div = document.createElement("div");
          div.className = "border";
          div.innerHTML = `<strong>${escapeHtml(comment.name)}</strong> - ${new Date(comment.timestamp).toLocaleString()}<br>${escapeHtml(comment.content)}`;
          if (comment.children.length) {
            const childContainer = document.createElement("div");
            childContainer.style.marginLeft = "20px";
            comment.children.forEach(child => childContainer.appendChild(render(child)));
            div.appendChild(childContainer);
          }
          return div;
        };

        const topLevel = comments.filter(c => !c.parent_id);
        if (topLevel.length === 0) {
          commentsContainer.innerHTML = "<p>No comments yet. Be the first to comment!</p>";
        } else {
          topLevel.forEach(top => {
            commentsContainer.appendChild(render(top));
          });
        }
      })
      .catch(err => {
        commentsContainer.innerHTML = "<p>Failed to load comments.</p>";
        console.error(err);
      });
  }

  // Simple escape to avoid XSS in comments rendering
  function escapeHtml(text) {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  loadComments();
})();
</script>

</body>
</html>
